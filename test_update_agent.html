<!DOCTYPE html>
<html>
<head>
    <title>Test Update Agent</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙƒÙŠÙ„</h1>
    
    <div id="status"></div>
    <div id="result"></div>
    
    <script>
        const API = 'http://localhost:8001/api';
        const userId = 'd6662114-b717-43a6-a47c-e29bfec54cec';
        
        async function testUpdate() {
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('result');
            
            try {
                statusDiv.innerHTML = '<p>â³ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...</p>';
                
                // 1. Login
                const loginResponse = await axios.post(`${API}/auth/login`, {
                    username: 'admin',
                    password: 'admin123'
                });
                
                const token = loginResponse.data.access_token;
                statusDiv.innerHTML += '<p>âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</p>';
                
                // 2. Get current user
                statusDiv.innerHTML += '<p>â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„...</p>';
                const getUserResponse = await axios.get(`${API}/users/${userId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                statusDiv.innerHTML += '<p>âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>';
                statusDiv.innerHTML += `<pre>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:\n${JSON.stringify(getUserResponse.data, null, 2)}</pre>`;
                
                // 3. Update user with new account_id
                statusDiv.innerHTML += '<p>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ...</p>';
                
                const updateData = {
                    display_name: getUserResponse.data.display_name,
                    phone: getUserResponse.data.phone,
                    governorate: getUserResponse.data.governorate,
                    address: getUserResponse.data.address || '',
                    account_id: '501-01'  // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                };
                
                console.log('ğŸ“¤ Sending update:', updateData);
                
                const updateResponse = await axios.put(`${API}/users/${userId}`, updateData, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                statusDiv.innerHTML += '<p>âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­!</p>';
                statusDiv.innerHTML += `<pre>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«:\n${JSON.stringify(updateResponse.data, null, 2)}</pre>`;
                
                // 4. Verify - get user again
                statusDiv.innerHTML += '<p>â³ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸...</p>';
                const verifyResponse = await axios.get(`${API}/users/${userId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                statusDiv.innerHTML += '<p>âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø§ÙƒØªÙ…Ù„</p>';
                
                if (verifyResponse.data.account_id === '501-01') {
                    resultDiv.innerHTML = '<h2 style="color: green;">âœ… Ø§Ù„Ù†Ø¬Ø§Ø­! Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø­ÙÙˆØ¸ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</h2>';
                    resultDiv.innerHTML += `<p>account_id: ${verifyResponse.data.account_id}</p>`;
                } else {
                    resultDiv.innerHTML = '<h2 style="color: red;">âŒ ÙØ´Ù„! Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù… ÙŠÙØ­ÙØ¸</h2>';
                    resultDiv.innerHTML += `<p>Expected: 501-01</p>`;
                    resultDiv.innerHTML += `<p>Got: ${verifyResponse.data.account_id || 'null'}</p>`;
                }
                
            } catch (error) {
                statusDiv.innerHTML += `<p style="color: red;">âŒ Ø®Ø·Ø£: ${error.message}</p>`;
                if (error.response) {
                    statusDiv.innerHTML += `<pre>Response: ${JSON.stringify(error.response.data, null, 2)}</pre>`;
                }
                console.error('Error:', error);
            }
        }
        
        // Run test on page load
        testUpdate();
    </script>
</body>
</html>
